@model Hrms_system.Models.UserProfileViewModel
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers

@{
    ViewData["Title"] = "My Profile";
}
<div id="statusMessage" class="mt-3"></div>


<div class="container mt-4">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 bg-light p-3">
            <div class="text-center">
                <img src="@Model.ProfileImageUrl" class="rounded-circle" width="100" height="100" alt="Profile Image">
                <h5 class="mt-2">@Model.Name</h5>
                <p>@Model.JobTitle</p>
                <p class="text-muted"><i class="bi bi-geo-alt"></i> Registered Office</p>
                <p><i class="bi bi-envelope"></i> @Model.OfficialEmail</p>
            </div>
            <hr>
            <ul class="nav flex-column">
                <li class="nav-item"><a class="nav-link active" href="#">Personal</a></li>
                <li class="nav-item"><a class="nav-link" href="#">Work</a></li>
                <li class="nav-item"><a class="nav-link" href="#">Education</a></li>
                <li class="nav-item"><a class="nav-link" href="#">Payroll</a></li>
            </ul>
        </div>


        <!-- Profile Content -->
        <div class="col-md-9">
            <!-- Personal Info -->
            <form id="personalForm" method="post" asp-controller="Profile" asp-action="UpdatePersonal">
            <div class="card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <span>Personal Information</span>
                    <button type="button" class="btn btn-sm btn-light text-primary" id="editPersonalInfo">
                        <i class="bi bi-pencil"></i> Edit
                    </button>
                </div>
                <div class="card-body">
                    <form method="post" asp-controller="Profile" asp-action="UpdatePersonal">
                        <div class="row">
                            <div class="col-md-6">
                                <label><strong>Name:</strong></label>
                                <input type="text" class="form-control" value="@Model.Name" readonly />

                                <label><strong>Blood Group:</strong></label>
                                <input type="text" class="form-control editable-field" name="BloodGroup" value="@Model.BloodGroup" disabled />
                            </div>
                            <div class="col-md-6">
                                <label><strong>Date of Birth:</strong></label>
                                <input type="date" class="form-control editable-field" asp-for="DateOfBirth" disabled />

                                <label><strong>Gender:</strong></label>
                                <select class="form-control editable-field" name="Gender" disabled>
                                    <option value="Male" selected="@(Model.Gender == "Male" ? "selected" : null)">Male</option>
                                    <option value="Female" selected="@(Model.Gender == "Female" ? "selected" : null)">Female</option>
                                    <option value="Other" selected="@(Model.Gender == "Other" ? "selected" : null)">Other</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary mt-3 d-none" id="saveChangesBtn">Save Changes</button>
                    </form>
                </div>
            </div>
            </form>

            <!-- Contact Info -->
            <form id="contactForm" method="post" asp-controller="Profile" asp-action="UpdateContact">
            <div class="card mt-3">
                <div class="card-header bg-primary text-white">
                    Contact Info
                </div>
                <div class="card-body">
                    <form method="post" asp-controller="Profile" asp-action="UpdateContact">
                        <label><strong>Official Email:</strong></label>
                        <input type="text" class="form-control" value="@Model.OfficialEmail" readonly />

                        <label><strong>Personal Email:</strong></label>
                        <input type="email" class="form-control" name="PersonalEmail" value="@Model.PersonalEmail" />

                        <label><strong>Phone Number:</strong></label>
                        <input type="text" class="form-control" name="PhoneNumber" value="@Model.PhoneNumber" />

                        <label><strong>Alternate Phone:</strong></label>
                        <input type="text" class="form-control" name="AlternatePhone" value="@Model.AlternatePhone" />

                        <button type="submit" class="btn btn-primary mt-3">Save Changes</button>
                    </form>
                </div>
            </div>
            </form>
            <!-- Address Info -->
            <form id="addressForm" method="post" asp-controller="Profile" asp-action="UpdateAddress">
            <div class="card mt-3">
                <div class="card-header bg-primary text-white">
                    Addresses
                </div>
                <div class="card-body">
                    <form method="post" asp-controller="Profile" asp-action="UpdateAddress">
                        <label><strong>Current Address:</strong></label>
                        <input type="text" class="form-control" name="CurrentAddress" value="@Model.CurrentAddress" />

                        <label><strong>Permanent Address:</strong></label>
                        <input type="text" class="form-control" name="PermanentAddress" value="@Model.PermanentAddress" />

                        <button type="submit" class="btn btn-primary mt-3">Save Changes</button>
                    </form>
                </div>
            </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Function to handle form submission via AJAX
    function handleAjaxForm(formId, successMsg) {
        const form = document.getElementById(formId);
        form.addEventListener("submit", function (e) {
            e.preventDefault();

            const formData = new FormData(form);
            fetch(form.action, {
                method: "POST",
                body: formData
            })
            .then(res => {
                if (!res.ok) throw new Error("Network response was not ok.");
                return res.text();
            })
            .then(() => {
                showMessage(successMsg, true);
            })
            .catch(() => {
                showMessage("Something went wrong. Please try again.", false);
            });
        });
    }

    // Show success or error message
    function showMessage(message, isSuccess) {
        const div = document.getElementById("statusMessage");
        div.innerHTML = `<div class="alert alert-${isSuccess ? "success" : "danger"}">${message}</div>`;
        setTimeout(() => div.innerHTML = "", 3000);
    }

    // Enable personal info edit
    document.getElementById("editPersonalInfo").addEventListener("click", function () {
        let fields = document.querySelectorAll(".editable-field");
        let saveButton = document.getElementById("saveChangesBtn");

        fields.forEach(field => field.removeAttribute("disabled"));
        if (saveButton) saveButton.classList.remove("d-none");
        this.style.display = "none";
    });

    // Attach AJAX handlers
    handleAjaxForm("personalForm", "Personal information updated successfully!");
    handleAjaxForm("contactForm", "Contact information updated successfully!");
    handleAjaxForm("addressForm", "Address updated successfully!");

     document.getElementById("profileImageForm").addEventListener("submit", function (e) {
        e.preventDefault();
        const form = document.getElementById("profileImageForm");
        const formData = new FormData(form);

        fetch(form.action, {
            method: "POST",
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                document.getElementById("profileImg").src = data.imageUrl + "?t=" + new Date().getTime(); // force reload
                alert("Profile image updated!");
            } else {
                alert("Upload failed!");
            }
        })
        .catch(() => {
            alert("Something went wrong!");
        });
    });


</script>

