@{
    ViewData["Title"] = "Employee Management";
    Layout = "_AdminLayout";
}






<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-4 border-bottom">
    <h1 class="h2">Employee Management</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-outline-secondary">Export</button>
            <button type="button" class="btn btn-sm btn-outline-secondary">Print</button>
        </div>
        <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addEmployeeModal">
            <i class="fas fa-plus"></i> Add Employee
        </button>
    </div>
</div>

<!-- Filter and Search -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-3">
                <label class="form-label">Department</label>
                <select class="form-select filter" data-column="3">
                    <option selected>All</option>
                    <option>IT</option>
                    <option>HR</option>
                    <option>Finance</option>
                    <option>Marketing</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Position</label>
                <select class="form-select filter" data-column="2">
                    <option selected>All</option>
                    <option>Manager</option>
                    <option>Developer</option>
                    <option>HR Specialist</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Status</label>
                <select class="form-select filter" data-column="5">
                    <option selected>All</option>
                    <option>Active</option>
                    <option>Inactive</option>
                    <option>On Leave</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Search</label>
                <div class="input-group">
                    <input type="text" id="tableSearch" class="form-control" placeholder="Search employees...">
                    <button class="btn btn-outline-secondary" type="button">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

    <!-- Employees Table -->
    <div class="card">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover table-admin" id="employeeTable">
                    <thead>
                        <tr>
                            <th>Employee ID</th>
                            <th>Name</th>
                            <th>Position</th>
                            <th>Department</th>
                            <th>Join Date</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="employeeBody">


                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Add Employee Modal -->
    <div class="modal fade" id="addEmployeeModal" tabindex="-1" aria-labelledby="addEmployeeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Employee</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="employeeForm">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">First Name</label>
                                <input type="text" id="FirstName" class="form-control" required />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Last Name</label>
                                <input type="text" id="LastName" class="form-control" required />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Email</label>
                                <input type="email" id="Email" class="form-control" required />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Phone</label>
                                <input type="tel" id="Phone" class="form-control" required />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Department</label>
                                <select id="Department" class="form-select" required>
                                    <option value="">Select</option>
                                    <option>IT</option>
                                    <option>HR</option>
                                    <option>Finance</option>
                                </select>
                                    <span id="departmentError" class="text-danger"></span>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Position</label>
                                <select id="Position" class="form-select" required>
                                    <option value="">Select</option>
                                    <option>Developer</option>
                                    <option>Manager</option>
                                    <option>HR Specialist</option>
                                </select>
                                <span id="positionError" class="text-danger"></span>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Join Date</label>
                                <input type="date" id="JoinDate" class="form-control" required />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Status</label>
                                <select id="Status" class="form-select" required>
                                    <option>Active</option>
                                    <option>Inactive</option>
                                    <option>On Leave</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button id="saveEmployeeBtn" class="btn btn-admin">Save Employee</button>
                </div>
            </div>
        </div>
    </div>

<!-- Edit Employee Modal -->
<div class="modal fade" id="editEmployeeModal" tabindex="-1" aria-labelledby="editEmployeeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Employee</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editEmployeeForm">
                    <input type="hidden" id="EditId" />
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">First Name</label>
                            <input type="text" id="EditFirstName" class="form-control" required />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Last Name</label>
                            <input type="text" id="EditLastName" class="form-control" required />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Email</label>
                            <input type="email" id="EditEmail" class="form-control" required />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Phone</label>
                            <input type="tel" id="EditPhone" class="form-control" required />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Department</label>
                            <select id="EditDepartment" class="form-select" required>
                                <option>IT</option>
                                <option>HR</option>
                                <option>Finance</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Position</label>
                            <select id="EditPosition" class="form-select" required>
                                <option>Developer</option>
                                <option>Manager</option>
                                <option>HR Specialist</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Join Date</label>
                            <input type="date" id="EditJoinDate" class="form-control" required />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Status</label>
                            <select id="EditStatus" class="form-select" required>
                                <option>Active</option>
                                <option>Inactive</option>
                                <option>On Leave</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button id="updateEmployeeBtn" class="btn btn-success">Update</button>
            </div>
        </div>
    </div>
</div>




@section Scripts {
    <script>
        $(document).ready(function () {
            // Initialize DataTable
            var table = $('#employeeTable').DataTable({
                "columnDefs": [
                    { "orderable": false, "targets": 6 } // Disable sorting for "Actions" column
                ]
            });

            // Load employees
            loadEmployees();

            function loadEmployees() {
                $.ajax({
                    url: '/Employee/GetAll',
                    method: 'GET',
                         success: function (data) {
            if (!data.success) {
                alert('Failed to load employees.');
                return;
            }

            table.clear();

            $.each(data.data, function (i, emp) {
                table.row.add([
                    emp.id,
                    emp.firstName + ' ' + emp.lastName,
                    emp.position,
                    emp.department,
                    formatDate(emp.joinDate),
                    emp.status,
                    `<button class="btn btn-sm btn-primary edit-btn" data-id="${emp.id}">Edit</button>
                     <button class="btn btn-sm btn-danger delete-btn" data-id="${emp.id}">Delete</button>`
                ]);
            });

            table.draw();
        },

                    error: function () {
                        alert('Error loading employees');
                    }
                });
            }

            function formatDate(dateString) {
                const date = new Date(dateString);
                const options = { year: 'numeric', month: 'short', day: 'numeric' };
                return date.toLocaleDateString(undefined, options);
            }

            // Search by keyword
            $('#tableSearch').on('keyup', function () {
                table.search(this.value).draw();
            });

            // Column-based filter
            $('.filter').on('change', function () {
                let colIndex = $(this).data('column');
                let val = this.value === 'All' ? '' : this.value;
                table.column(colIndex).search(val).draw();
            });

        // In your employee management JavaScript
        $('#saveEmployeeBtn').click(function() {
            var formData = {
                FirstName: $('#FirstName').val(),
                LastName: $('#LastName').val(),
                Email: $('#Email').val(),
                Phone: $('#Phone').val(),
                Department: $('#Department').val(),
                Position: $('#Position').val(),
                JoinDate: $('#JoinDate').val(),
                Status: $('#Status').val(),
                CompanyId: 1 // Set this appropriately
            };

            $.ajax({
                url: '/Employee/Add',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function(response) {
                    if (response.success) {
                        $('#addEmployeeModal').modal('hide');
                        $('#employeeForm')[0].reset();
                        loadEmployees();
                        alert('Employee added successfully');
                    } else {
                        // Display validation errors
                        var errorMsg = response.message;
                        if (response.errors) {
                            errorMsg += '\n\n' + Object.entries(response.errors)
                                .map(([key, val]) => `${key}: ${val.join(', ')}`)
                                .join('\n');
                        }
                        alert(errorMsg);
                    }
                },
                error: function(xhr) {
                    var errorMsg = xhr.responseJSON?.message || 'Something went wrong!';
        if (xhr.responseJSON?.errors) {
            errorMsg += '\n\n' + Object.entries(xhr.responseJSON.errors)
                .map(([key, val]) => {
                    // If val is array (e.g., ["Error 1", "Error 2"]), join it; otherwise use as-is
                    return `${key}: ${Array.isArray(val) ? val.join(', ') : val}`;
                })
                .join('\n');
        }

                    alert(errorMsg);
                }
            });
        });

                    // Edit button click
        $('#employeeTable').on('click', '.edit-btn', function () {
            const id = $(this).data('id');
            $.get('/Employee/GetById/' + id, function (emp) {
                $('#EditId').val(emp.id);
                $('#EditFirstName').val(emp.firstName);
                $('#EditLastName').val(emp.lastName);
                $('#EditEmail').val(emp.email);
                $('#EditPhone').val(emp.phone);
                $('#EditDepartment').val(emp.department);
                $('#EditPosition').val(emp.position);
                $('#EditJoinDate').val(emp.joinDate.split('T')[0]);
                $('#EditStatus').val(emp.status);

                $('#editEmployeeModal').modal('show');
            });
        });

        // Update employee
        $('#updateEmployeeBtn').click(function () {
            var formData = new FormData();
            formData.append("Id", $('#EditId').val());
            formData.append("FirstName", $('#EditFirstName').val());
            formData.append("LastName", $('#EditLastName').val());
            formData.append("Email", $('#EditEmail').val());
            formData.append("Phone", $('#EditPhone').val());
            formData.append("Department", $('#EditDepartment').val());
            formData.append("Position", $('#EditPosition').val());
            formData.append("JoinDate", $('#EditJoinDate').val());
            formData.append("Status", $('#EditStatus').val());

            $.ajax({
                url: '/Employee/Update',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function (res) {
                    if (res.success) {
                        $('#editEmployeeModal').modal('hide');
                        loadEmployees();
                        alert(res.message);
                    }
                },
                error: function () {
                    alert('Error updating employee');
                }
            });
        });

        // Delete button click
        $('#employeeTable').on('click', '.delete-btn', function () {
            const id = $(this).data('id');
            if (confirm('Are you sure you want to delete this employee?')) {
                $.ajax({
                    url: '/Employee/Delete/' + id,
                    type: 'DELETE',
                    success: function (res) {
                        if (res.success) {
                            loadEmployees();
                            alert(res.message);
                        }
                    },
                    error: function () {
                        alert('Error deleting employee');
                    }
                });
            }
        });

        });
    </script>
}


